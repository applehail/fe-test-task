"use strict";var Ee=Object.create;var P=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var we=Object.getOwnPropertyNames;var Te=Object.getPrototypeOf,Ne=Object.prototype.hasOwnProperty;var Se=(r,e)=>{for(var o in e)P(r,o,{get:e[o],enumerable:!0})},j=(r,e,o,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of we(e))!Ne.call(r,s)&&s!==o&&P(r,s,{get:()=>e[s],enumerable:!(t=z(e,s))||t.enumerable});return r};var g=(r,e,o)=>(o=r!=null?Ee(Te(r)):{},j(e||!r||!r.__esModule?P(o,"default",{value:r,enumerable:!0}):o,r)),Ue=r=>j(P({},"__esModule",{value:!0}),r),u=(r,e,o,t)=>{for(var s=t>1?void 0:t?z(e,o):e,p=r.length-1,L;p>=0;p--)(L=r[p])&&(s=(t?L(e,o,s):L(s))||s);return t&&s&&P(e,o,s),s};var Ie={};Se(Ie,{userRouter:()=>M});module.exports=Ue(Ie);var ye=g(require("express"));var i=require("zod");var q=require("zod"),x={id:q.z.string().refine(r=>!isNaN(Number(r)),"ID must be a numeric value").transform(Number).refine(r=>r>0,"ID must be a positive number"),idNumber:q.z.number().refine(r=>r>0,"ID must be a positive number")};var Be=i.z.object({id:x.id,is_active:i.z.boolean(),name:i.z.string(),login:i.z.string(),password:i.z.string().optional(),role:i.z.string(),role_id:i.z.number(),email:i.z.string().optional(),phone:i.z.string().optional()}),D=i.z.object({id:x.id}),k=i.z.object({name:i.z.string(),login:i.z.string(),password:i.z.string(),role_id:i.z.number(),email:i.z.string(),phone:i.z.string()}).required({name:!0,login:!0,role_id:!0}),V=i.z.object({id:x.id,is_active:i.z.boolean(),name:i.z.string(),password:i.z.string().optional(),role_id:i.z.string(),email:i.z.string().optional(),phone:i.z.string().optional()}).required({id:!0,name:!0,role_id:!0});var m=require("http-status-codes"),ge=g(require("jsonwebtoken"));var K=g(require("jssha")),T=r=>{let e=new K.default("SHA-256","TEXT",{encoding:"UTF8"});return e.update(r),e.getHash("HEX")};var $=async(r,e,o)=>{let t;return o?(t=await r.findOneBy({[o]:e[o]}).catch(s=>console.log("find by on",s)),t?r.merge(t,e):t=r.create(e)):t=r.create(e),await r.save(t)},Q=async(r,e)=>{let o=r.create(e);return await r.insert(o)};var Y=require("typeorm");var S=require("typeorm");var l=require("typeorm");var a=class{};u([(0,l.Column)("integer",{primary:!0,name:"id",generated:!0})],a.prototype,"id",2),u([(0,l.Column)("boolean",{name:"is_active",default:!0})],a.prototype,"is_active",2),u([(0,l.Column)("text",{name:"name",nullable:!1})],a.prototype,"name",2),u([(0,l.Column)("text",{name:"login",nullable:!1})],a.prototype,"login",2),u([(0,l.Column)("text",{name:"password",nullable:!1})],a.prototype,"password",2),u([(0,l.Column)("text",{name:"email",nullable:!0})],a.prototype,"email",2),u([(0,l.Column)("text",{name:"phone",nullable:!0})],a.prototype,"phone",2),u([(0,l.JoinColumn)({name:"role_id",referencedColumnName:"id"}),(0,l.ManyToOne)(()=>d,e=>e.users)],a.prototype,"role",2),a=u([(0,l.Entity)("user")],a);var d=class{};u([(0,S.Column)("integer",{primary:!0,name:"id"})],d.prototype,"id",2),u([(0,S.Column)("text",{name:"name"})],d.prototype,"name",2),u([(0,S.OneToMany)(()=>a,e=>e.role)],d.prototype,"users",2),d=u([(0,S.Entity)("role")],d);var v=class{constructor(){this.name="Initial1723140820802"}async up(e){await e.query('CREATE TABLE "user" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "is_active" boolean NOT NULL DEFAULT (1), "name" text NOT NULL, "login" text NOT NULL, "password" text NOT NULL, "email" text, "phone" text, "role_id" integer)'),await e.query('CREATE TABLE "role" ("id" integer PRIMARY KEY NOT NULL, "name" text NOT NULL)'),await e.query('CREATE TABLE "temporary_user" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "is_active" boolean NOT NULL DEFAULT (1), "name" text NOT NULL, "login" text NOT NULL, "password" text NOT NULL, "email" text, "phone" text, "role_id" integer, CONSTRAINT "FK_fb2e442d14add3cefbdf33c4561" FOREIGN KEY ("role_id") REFERENCES "role" ("id") ON DELETE NO ACTION ON UPDATE NO ACTION)'),await e.query('INSERT INTO "temporary_user"("id", "is_active", "name", "login", "password", "email", "phone", "role_id") SELECT "id", "is_active", "name", "login", "password", "email", "phone", "role_id" FROM "user"'),await e.query('DROP TABLE "user"'),await e.query('ALTER TABLE "temporary_user" RENAME TO "user"')}async down(e){await e.query('ALTER TABLE "user" RENAME TO "temporary_user"'),await e.query('CREATE TABLE "user" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "is_active" boolean NOT NULL DEFAULT (1), "name" text NOT NULL, "login" text NOT NULL, "password" text NOT NULL, "email" text, "phone" text, "role_id" integer)'),await e.query('INSERT INTO "user"("id", "is_active", "name", "login", "password", "email", "phone", "role_id") SELECT "id", "is_active", "name", "login", "password", "email", "phone", "role_id" FROM "temporary_user"'),await e.query('DROP TABLE "temporary_user"'),await e.query('DROP TABLE "role"'),await e.query('DROP TABLE "user"')}};var b=class{constructor(){this.name="Data1723140820803"}async up(e){await e.query('INSERT INTO "role" (id, name) VALUES (1, "admin")'),await e.query('INSERT INTO "role" (id, name) VALUES (2, "manager")');let o=T("a"),t=T("a");await e.query('INSERT INTO "user" (name, login, password, role_id) VALUES ("\u0410\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0430\u0442\u043E\u0440", "admin", "'+o+'", 1)'),await e.query('INSERT INTO "user" (name, login, password, role_id, email, phone) VALUES ("\u041C\u0435\u043D\u0435\u0434\u0436\u0435\u0440", "manager", "'+t+'", 2, "email@email.ru", "+79511239342")')}async down(e){await e.query('DELETE FROM "role"'),await e.query('DELETE FROM "user"')}};var Z=new Y.DataSource({name:"cp",type:"sqlite",database:"db/main.sqlite",synchronize:!1,migrations:[v,b],entities:[a,d]});var h=r=>Z.getRepository(r),y={findRoles:async()=>h(d).find({order:{id:"asc"}}),findAll:async()=>h(a).find({order:{id:"desc"},relations:["role"]}),findById:async r=>await h(a).findOne({where:{id:r},relations:["role"]}).catch(t=>console.log("findById",t))??null,findByLoginPassword:async r=>await h(a).findOne({where:r,relations:["role"]}).catch(t=>console.log("findByLoginPassword",t))??null,delete:async r=>{let o=await h(a).delete({id:r}).catch(t=>console.log("delete",t));return!!o?.affected&&o?.affected>0},add:async r=>{let e=h(a);if(await e.findOne({where:{login:r.login}})!==null)return!1;let t={...r,role:await h(d).findOneBy({id:r.role_id})};return t.password=T(r.password),await Q(e,t)},update:async(r,e)=>{let o=h(a),t={...e,id:r,role:await h(d).findOneBy({id:e.role_id})};return t.password&&t.password!=="*"?t.password=T(t.password):delete t.password,await $(o,t,"id")}};var I=require("zod"),n=class{constructor(e,o){this.data=e,this.statusCode=o}};var ar=I.z.object({items:I.z.array(I.z.number())}).required();var G=g(require("dotenv")),c=require("envalid");G.default.config();var N=(0,c.cleanEnv)(process.env,{NODE_ENV:(0,c.str)({devDefault:(0,c.testOnly)("test"),choices:["development","production","test"]}),HOST:(0,c.host)({devDefault:(0,c.testOnly)("localhost")}),PORT:(0,c.port)({devDefault:(0,c.testOnly)(3e3)}),CORS_ORIGIN:(0,c.str)({devDefault:(0,c.testOnly)("http://localhost:3000")}),SECRET:(0,c.str)({devDefault:(0,c.testOnly)("")})});var le=g(require("cors")),C=g(require("express")),Re=require("pino");var J=g(require("express"));var W=require("http-status-codes");var R=(r,e)=>e.status(r.statusCode).send(r.data),U=r=>(e,o,t)=>{try{let s={...e.body,...e.query,...e.params};console.log("validateRequest:",s),r.parse(s),t()}catch(s){console.log("err:",s);let p=[];s.errors.map(F=>{let he=F.message+": "+F.path.join(",");p.push(he)});let L=p.join(", "),H=W.StatusCodes.BAD_REQUEST;o.status(H).send(new n(L,H))}};var O=require("zod");var X=O.z.object({login:O.z.string(),password:O.z.string()}).required(),Rr=O.z.object({token:O.z.string(),user_id:x.id,role:O.z.string()});var ee=(()=>{let r=J.default.Router();return r.post("/",U(X),async(e,o)=>{let t=e.body,s=await E.findByLoginPassword(t);R(s,o)}),r})();var oe=g(require("express"));var B=require("http-status-codes");var re={getConfig:async()=>{try{let r={roles:{}};return(await y.findRoles()).forEach(o=>{r.roles[o.id]=o.name}),new n(r,B.StatusCodes.OK)}catch(r){let e=`Error get config: ${r.message}`;return w.error(e),new n(e,B.StatusCodes.INTERNAL_SERVER_ERROR)}}};var te=(()=>{let r=oe.default.Router();return r.get("/",async(e,o)=>{let t=await re.getConfig();R(t,o)}),r})();var se=g(require("express")),ne=require("http-status-codes");var ie=(()=>{let r=se.default.Router();return r.get("/",(e,o)=>{let t=new n("ok",ne.StatusCodes.OK);R(t,o)}),r})();var A=require("http-status-codes"),ae=g(require("jsonwebtoken"));var Oe=["/auth","/health-check","/","/favicon.ico","/cp/"],xe="/cp",Le=(r,e,o)=>{let{SECRET:t}=N;if(Oe.includes(r.originalUrl)){o();return}if(r.originalUrl.includes(xe)){o();return}let s=r.headers.authorization;if(!s)return e.status(A.StatusCodes.UNAUTHORIZED).send("Access Denied / Unauthorized request");try{if(s=s.split(" ")[1],!s)return e.status(A.StatusCodes.UNAUTHORIZED).send("Unauthorized request");let p=ae.default.verify(s,t);if(!p)return e.status(A.StatusCodes.UNAUTHORIZED).send("Unauthorized request");r.locals||(r.locals={}),r.locals.user=p,o()}catch{return e.status(A.StatusCodes.BAD_REQUEST).send("Invalid Token")}},me=()=>[Le];var pe=require("http-status-codes"),Pe=(r,e)=>{e.sendStatus(pe.StatusCodes.NOT_FOUND)},Ae=(r,e,o,t)=>{o.locals.err=r,t(r)},ce=()=>[Pe,Ae];var ue=require("pino-http");var _e=(r,e)=>({error:e.locals.err,responseBody:e.locals.responseBody}),ve=(r,e,o)=>{if(!N.isProduction){let s=e.send;e.send=function(p){return e.locals.responseBody=p,e.send=s,s.call(e,p)}}o()},be=r=>{let e={enabled:!0,customProps:_e,customSuccessMessage:o=>`<- completed ${o.method}`,serializers:{req:o=>({id:o.raw.id,method:o.raw.method,url:o.raw.url,body:o.raw.body,authorization:o.raw.headers.authorization}),res:o=>({statusCode:o.raw.statusCode})},...r};return[ve,(0,ue.pinoHttp)(e)]},de=be();var w=(0,Re.pino)({name:"server start"}),f=(0,C.default)();f.set("trust proxy",!0);f.use(C.default.json({limit:"5mb"}));f.use(C.default.urlencoded({extended:!0}));f.use((0,le.default)({origin:N.CORS_ORIGIN,credentials:!0}));f.use(de);f.use(me());f.use("/health-check",ie);f.use("/auth",ee);f.use("/config",te);f.use("/users",M);f.use(ce());var _=r=>({id:r.id,is_active:r.is_active,login:r.login,name:r.name,password:"*",role:r.role?.name,role_id:r.role?.id,email:r.email,phone:r.phone}),fe=r=>r.map(e=>_(e));var E={findAll:async()=>{try{let r=await y.findAll();return r?new n(fe(r),m.StatusCodes.OK):new n(null,m.StatusCodes.NOT_FOUND)}catch(r){let e=`Error finding all users: ${r.message}`;return w.error(e),new n(null,m.StatusCodes.INTERNAL_SERVER_ERROR)}},findById:async r=>{try{let e=await y.findById(r);if(!e)return new n(null,m.StatusCodes.NOT_FOUND);let o=await y.findRoles();return new n({..._(e),config:{roles:o}},m.StatusCodes.OK)}catch(e){let o=`Error finding user with id ${r}: ${e.message}`;return w.error(o),new n(null,m.StatusCodes.INTERNAL_SERVER_ERROR)}},findByLoginPassword:async r=>{try{let e={...r};e.password=T(e.password);let o=await y.findByLoginPassword(e);if(!o)return new n("user not found",m.StatusCodes.NOT_FOUND);let t=_(o),s={user_id:t.id,role:t.role},p=ge.default.sign(s,N.SECRET);return new n({token:p,...s},m.StatusCodes.OK)}catch(e){let o=`Error finding user with login ${r.login}: ${e.message}`;return w.error(o),new n("",m.StatusCodes.INTERNAL_SERVER_ERROR)}},delete:async r=>{try{return r===1?new n("you cannot delete the main administrator",m.StatusCodes.BAD_REQUEST):await y.delete(r)?new n("",m.StatusCodes.OK):new n("",m.StatusCodes.NOT_FOUND)}catch(e){let o=`Error deleting user with id ${r}: ${e.message}`;return w.error(o),new n(o,m.StatusCodes.INTERNAL_SERVER_ERROR)}},add:async r=>{try{let e=await y.add(r);return e?new n({id:e?.identifiers[0].id},m.StatusCodes.OK):new n("user with that login exists",m.StatusCodes.CONFLICT)}catch(e){let o=`Error adding user: ${e.message}`;return w.error(o),new n(o,m.StatusCodes.INTERNAL_SERVER_ERROR)}},update:async(r,e)=>{try{let o=await y.update(r,e);return console.log("\u{1F680} ~ update: ~ res:",o),new n(_(o),m.StatusCodes.OK)}catch(o){let t=`Error updating user: ${o.message}`;return w.error(t),new n(t,m.StatusCodes.INTERNAL_SERVER_ERROR)}}};var M=(()=>{let r=ye.default.Router();return r.get("/me",async(e,o)=>{let t=e.locals?.user,s=await E.findById(t.user_id);R(s,o)}),r.get("/",async(e,o)=>{let t=await E.findAll();R(t,o)}),r.get("/:id",U(D),async(e,o)=>{let t=parseInt(e.params.id,10),s=await E.findById(t);R(s,o)}),r.delete("/:id",U(D),async(e,o)=>{let t=parseInt(e.params.id,10),s=await E.delete(t);R(s,o)}),r.post("/",U(k),async(e,o)=>{let t=e.body,s=await E.add(t);R(s,o)}),r.put("/:id",U(V),async(e,o)=>{let t=e.body,s=parseInt(e.params.id,10),p=await E.update(s,t);R(p,o)}),r})();0&&(module.exports={userRouter});
