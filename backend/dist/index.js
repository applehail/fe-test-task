"use strict";var Ee=Object.create;var q=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var we=Object.getOwnPropertyNames;var Te=Object.getPrototypeOf,Ne=Object.prototype.hasOwnProperty;var Se=(r,e,o,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of we(e))!Ne.call(r,s)&&s!==o&&q(r,s,{get:()=>e[s],enumerable:!(t=F(e,s))||t.enumerable});return r};var h=(r,e,o)=>(o=r!=null?Ee(Te(r)):{},Se(e||!r||!r.__esModule?q(o,"default",{value:r,enumerable:!0}):o,r));var u=(r,e,o,t)=>{for(var s=t>1?void 0:t?F(e,o):e,p=r.length-1,L;p>=0;p--)(L=r[p])&&(s=(t?L(e,o,s):L(s))||s);return t&&s&&q(e,o,s),s};var go=require("reflect-metadata");var V=h(require("dotenv")),c=require("envalid");V.default.config();var y=(0,c.cleanEnv)(process.env,{NODE_ENV:(0,c.str)({devDefault:(0,c.testOnly)("test"),choices:["development","production","test"]}),HOST:(0,c.host)({devDefault:(0,c.testOnly)("localhost")}),PORT:(0,c.port)({devDefault:(0,c.testOnly)(3e3)}),CORS_ORIGIN:(0,c.str)({devDefault:(0,c.testOnly)("http://localhost:3000")}),SECRET:(0,c.str)({devDefault:(0,c.testOnly)("")})});var fe=h(require("cors")),C=h(require("express")),ge=require("pino");var W=h(require("express"));var m=require("http-status-codes"),Y=h(require("jsonwebtoken"));var j=h(require("jssha")),N=r=>{let e=new j.default("SHA-256","TEXT",{encoding:"UTF8"});return e.update(r),e.getHash("HEX")};var k=async(r,e,o)=>{let t;return o?(t=await r.findOneBy({[o]:e[o]}).catch(s=>console.log("find by on",s)),t?r.merge(t,e):t=r.create(e)):t=r.create(e),await r.save(t)},K=async(r,e)=>{let o=r.create(e);return await r.insert(o)};var $=require("typeorm");var S=require("typeorm");var l=require("typeorm");var a=class{};u([(0,l.Column)("integer",{primary:!0,name:"id",generated:!0})],a.prototype,"id",2),u([(0,l.Column)("boolean",{name:"is_active",default:!0})],a.prototype,"is_active",2),u([(0,l.Column)("text",{name:"name",nullable:!1})],a.prototype,"name",2),u([(0,l.Column)("text",{name:"login",nullable:!1})],a.prototype,"login",2),u([(0,l.Column)("text",{name:"password",nullable:!1})],a.prototype,"password",2),u([(0,l.Column)("text",{name:"email",nullable:!0})],a.prototype,"email",2),u([(0,l.Column)("text",{name:"phone",nullable:!0})],a.prototype,"phone",2),u([(0,l.JoinColumn)({name:"role_id",referencedColumnName:"id"}),(0,l.ManyToOne)(()=>d,e=>e.users)],a.prototype,"role",2),a=u([(0,l.Entity)("user")],a);var d=class{};u([(0,S.Column)("integer",{primary:!0,name:"id"})],d.prototype,"id",2),u([(0,S.Column)("text",{name:"name"})],d.prototype,"name",2),u([(0,S.OneToMany)(()=>a,e=>e.role)],d.prototype,"users",2),d=u([(0,S.Entity)("role")],d);var A=class{constructor(){this.name="Initial1723140820802"}async up(e){await e.query('CREATE TABLE "user" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "is_active" boolean NOT NULL DEFAULT (1), "name" text NOT NULL, "login" text NOT NULL, "password" text NOT NULL, "email" text, "phone" text, "role_id" integer)'),await e.query('CREATE TABLE "role" ("id" integer PRIMARY KEY NOT NULL, "name" text NOT NULL)'),await e.query('CREATE TABLE "temporary_user" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "is_active" boolean NOT NULL DEFAULT (1), "name" text NOT NULL, "login" text NOT NULL, "password" text NOT NULL, "email" text, "phone" text, "role_id" integer, CONSTRAINT "FK_fb2e442d14add3cefbdf33c4561" FOREIGN KEY ("role_id") REFERENCES "role" ("id") ON DELETE NO ACTION ON UPDATE NO ACTION)'),await e.query('INSERT INTO "temporary_user"("id", "is_active", "name", "login", "password", "email", "phone", "role_id") SELECT "id", "is_active", "name", "login", "password", "email", "phone", "role_id" FROM "user"'),await e.query('DROP TABLE "user"'),await e.query('ALTER TABLE "temporary_user" RENAME TO "user"')}async down(e){await e.query('ALTER TABLE "user" RENAME TO "temporary_user"'),await e.query('CREATE TABLE "user" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "is_active" boolean NOT NULL DEFAULT (1), "name" text NOT NULL, "login" text NOT NULL, "password" text NOT NULL, "email" text, "phone" text, "role_id" integer)'),await e.query('INSERT INTO "user"("id", "is_active", "name", "login", "password", "email", "phone", "role_id") SELECT "id", "is_active", "name", "login", "password", "email", "phone", "role_id" FROM "temporary_user"'),await e.query('DROP TABLE "temporary_user"'),await e.query('DROP TABLE "role"'),await e.query('DROP TABLE "user"')}};var _=class{constructor(){this.name="Data1723140820803"}async up(e){await e.query('INSERT INTO "role" (id, name) VALUES (1, "admin")'),await e.query('INSERT INTO "role" (id, name) VALUES (2, "manager")');let o=N("a"),t=N("a");await e.query('INSERT INTO "user" (name, login, password, role_id) VALUES ("\u0410\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0430\u0442\u043E\u0440", "admin", "'+o+'", 1)'),await e.query('INSERT INTO "user" (name, login, password, role_id, email, phone) VALUES ("\u041C\u0435\u043D\u0435\u0434\u0436\u0435\u0440", "manager", "'+t+'", 2, "email@email.ru", "+79511239342")')}async down(e){await e.query('DELETE FROM "role"'),await e.query('DELETE FROM "user"')}};var b=new $.DataSource({name:"cp",type:"sqlite",database:"db/main.sqlite",synchronize:!1,migrations:[A,_],entities:[a,d]});var w=r=>b.getRepository(r),E={findRoles:async()=>w(d).find({order:{id:"asc"}}),findAll:async()=>w(a).find({order:{id:"desc"},relations:["role"]}),findById:async r=>await w(a).findOne({where:{id:r},relations:["role"]}).catch(t=>console.log("findById",t))??null,findByLoginPassword:async r=>await w(a).findOne({where:r,relations:["role"]}).catch(t=>console.log("findByLoginPassword",t))??null,delete:async r=>{let o=await w(a).delete({id:r}).catch(t=>console.log("delete",t));return!!o?.affected&&o?.affected>0},add:async r=>{let e=w(a);if(await e.findOne({where:{login:r.login}})!==null)return!1;let t={...r,role:await w(d).findOneBy({id:r.role_id})};return t.password=N(r.password),await K(e,t)},update:async(r,e)=>{let o=w(a),t={...e,id:r,role:await w(d).findOneBy({id:e.role_id})};return t.password&&t.password!=="*"?t.password=N(t.password):delete t.password,await k(o,t,"id")}};var I=require("zod"),n=class{constructor(e,o){this.data=e,this.statusCode=o}};var sr=I.z.object({items:I.z.array(I.z.number())}).required();var P=r=>({id:r.id,is_active:r.is_active,login:r.login,name:r.name,password:"*",role:r.role?.name,role_id:r.role?.id,email:r.email,phone:r.phone}),Q=r=>r.map(e=>P(e));var T={findAll:async()=>{try{let r=await E.findAll();return r?new n(Q(r),m.StatusCodes.OK):new n(null,m.StatusCodes.NOT_FOUND)}catch(r){let e=`Error finding all users: ${r.message}`;return R.error(e),new n(null,m.StatusCodes.INTERNAL_SERVER_ERROR)}},findById:async r=>{try{let e=await E.findById(r);if(!e)return new n(null,m.StatusCodes.NOT_FOUND);let o=await E.findRoles();return new n({...P(e),config:{roles:o}},m.StatusCodes.OK)}catch(e){let o=`Error finding user with id ${r}: ${e.message}`;return R.error(o),new n(null,m.StatusCodes.INTERNAL_SERVER_ERROR)}},findByLoginPassword:async r=>{try{let e={...r};e.password=N(e.password);let o=await E.findByLoginPassword(e);if(!o)return new n("user not found",m.StatusCodes.NOT_FOUND);let t=P(o),s={user_id:t.id,role:t.role},p=Y.default.sign(s,y.SECRET);return new n({token:p,...s},m.StatusCodes.OK)}catch(e){let o=`Error finding user with login ${r.login}: ${e.message}`;return R.error(o),new n("",m.StatusCodes.INTERNAL_SERVER_ERROR)}},delete:async r=>{try{return r===1?new n("you cannot delete the main administrator",m.StatusCodes.BAD_REQUEST):await E.delete(r)?new n("",m.StatusCodes.OK):new n("",m.StatusCodes.NOT_FOUND)}catch(e){let o=`Error deleting user with id ${r}: ${e.message}`;return R.error(o),new n(o,m.StatusCodes.INTERNAL_SERVER_ERROR)}},add:async r=>{try{let e=await E.add(r);return e?new n({id:e?.identifiers[0].id},m.StatusCodes.OK):new n("user with that login exists",m.StatusCodes.CONFLICT)}catch(e){let o=`Error adding user: ${e.message}`;return R.error(o),new n(o,m.StatusCodes.INTERNAL_SERVER_ERROR)}},update:async(r,e)=>{try{let o=await E.update(r,e);return console.log("\u{1F680} ~ update: ~ res:",o),new n(P(o),m.StatusCodes.OK)}catch(o){let t=`Error updating user: ${o.message}`;return R.error(t),new n(t,m.StatusCodes.INTERNAL_SERVER_ERROR)}}};var Z=require("http-status-codes");var f=(r,e)=>e.status(r.statusCode).send(r.data),O=r=>(e,o,t)=>{try{let s={...e.body,...e.query,...e.params};console.log("validateRequest:",s),r.parse(s),t()}catch(s){console.log("err:",s);let p=[];s.errors.map(z=>{let he=z.message+": "+z.path.join(",");p.push(he)});let L=p.join(", "),H=Z.StatusCodes.BAD_REQUEST;o.status(H).send(new n(L,H))}};var U=require("zod");var D=require("zod"),x={id:D.z.string().refine(r=>!isNaN(Number(r)),"ID must be a numeric value").transform(Number).refine(r=>r>0,"ID must be a positive number"),idNumber:D.z.number().refine(r=>r>0,"ID must be a positive number")};var G=U.z.object({login:U.z.string(),password:U.z.string()}).required(),hr=U.z.object({token:U.z.string(),user_id:x.id,role:U.z.string()});var X=(()=>{let r=W.default.Router();return r.post("/",O(G),async(e,o)=>{let t=e.body,s=await T.findByLoginPassword(t);f(s,o)}),r})();var ee=h(require("express"));var B=require("http-status-codes");var J={getConfig:async()=>{try{let r={roles:{}};return(await E.findRoles()).forEach(o=>{r.roles[o.id]=o.name}),new n(r,B.StatusCodes.OK)}catch(r){let e=`Error get config: ${r.message}`;return R.error(e),new n(e,B.StatusCodes.INTERNAL_SERVER_ERROR)}}};var re=(()=>{let r=ee.default.Router();return r.get("/",async(e,o)=>{let t=await J.getConfig();f(t,o)}),r})();var oe=h(require("express")),te=require("http-status-codes");var se=(()=>{let r=oe.default.Router();return r.get("/",(e,o)=>{let t=new n("ok",te.StatusCodes.OK);f(t,o)}),r})();var ae=h(require("express"));var i=require("zod");var kr=i.z.object({id:x.id,is_active:i.z.boolean(),name:i.z.string(),login:i.z.string(),password:i.z.string().optional(),role:i.z.string(),role_id:i.z.number(),email:i.z.string().optional(),phone:i.z.string().optional()}),M=i.z.object({id:x.id}),ne=i.z.object({name:i.z.string(),login:i.z.string(),password:i.z.string(),role_id:i.z.number(),email:i.z.string(),phone:i.z.string()}).required({name:!0,login:!0,role_id:!0}),ie=i.z.object({id:x.id,is_active:i.z.boolean(),name:i.z.string(),password:i.z.string().optional(),role_id:i.z.string(),email:i.z.string().optional(),phone:i.z.string().optional()}).required({id:!0,name:!0,role_id:!0});var me=(()=>{let r=ae.default.Router();return r.get("/me",async(e,o)=>{let t=e.locals?.user,s=await T.findById(t.user_id);f(s,o)}),r.get("/",async(e,o)=>{let t=await T.findAll();f(t,o)}),r.get("/:id",O(M),async(e,o)=>{let t=parseInt(e.params.id,10),s=await T.findById(t);f(s,o)}),r.delete("/:id",O(M),async(e,o)=>{let t=parseInt(e.params.id,10),s=await T.delete(t);f(s,o)}),r.post("/",O(ne),async(e,o)=>{let t=e.body,s=await T.add(t);f(s,o)}),r.put("/:id",O(ie),async(e,o)=>{let t=e.body,s=parseInt(e.params.id,10),p=await T.update(s,t);f(p,o)}),r})();var v=require("http-status-codes"),pe=h(require("jsonwebtoken"));var Oe=["/auth","/health-check","/","/favicon.ico","/cp/"],Ue="/cp",xe=(r,e,o)=>{let{SECRET:t}=y;if(Oe.includes(r.originalUrl)){o();return}if(r.originalUrl.includes(Ue)){o();return}let s=r.headers.authorization;if(!s)return e.status(v.StatusCodes.UNAUTHORIZED).send("Access Denied / Unauthorized request");try{if(s=s.split(" ")[1],!s)return e.status(v.StatusCodes.UNAUTHORIZED).send("Unauthorized request");let p=pe.default.verify(s,t);if(!p)return e.status(v.StatusCodes.UNAUTHORIZED).send("Unauthorized request");r.locals||(r.locals={}),r.locals.user=p,o()}catch{return e.status(v.StatusCodes.BAD_REQUEST).send("Invalid Token")}},ce=()=>[xe];var ue=require("http-status-codes"),Le=(r,e)=>{e.sendStatus(ue.StatusCodes.NOT_FOUND)},Pe=(r,e,o,t)=>{o.locals.err=r,t(r)},de=()=>[Le,Pe];var le=require("pino-http");var ve=(r,e)=>({error:e.locals.err,responseBody:e.locals.responseBody}),Ae=(r,e,o)=>{if(!y.isProduction){let s=e.send;e.send=function(p){return e.locals.responseBody=p,e.send=s,s.call(e,p)}}o()},_e=r=>{let e={enabled:!0,customProps:ve,customSuccessMessage:o=>`<- completed ${o.method}`,serializers:{req:o=>({id:o.raw.id,method:o.raw.method,url:o.raw.url,body:o.raw.body,authorization:o.raw.headers.authorization}),res:o=>({statusCode:o.raw.statusCode})},...r};return[Ae,(0,le.pinoHttp)(e)]},Re=_e();var R=(0,ge.pino)({name:"server start"}),g=(0,C.default)();g.set("trust proxy",!0);g.use(C.default.json({limit:"5mb"}));g.use(C.default.urlencoded({extended:!0}));g.use((0,fe.default)({origin:y.CORS_ORIGIN,credentials:!0}));g.use(Re);g.use(ce());g.use("/health-check",se);g.use("/auth",X);g.use("/config",re);g.use("/users",me);g.use(de());b.initialize().then(()=>{console.log("db initialized")}).catch(r=>{console.error("db error",r)});var be=g.listen(y.PORT,()=>{let{NODE_ENV:r,HOST:e,PORT:o}=y;R.info(`Server (${r}) running on port http://${e}:${o}`)}),ye=()=>{R.info("sigint received, shutting down"),be.close(()=>{R.info("server closed"),process.exit()}),setTimeout(()=>process.exit(1),1e4).unref()};process.on("SIGINT",ye);process.on("SIGTERM",ye);
